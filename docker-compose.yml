version: '3.8'

services:
  db:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-heady}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-heady123}
      POSTGRES_DB: ${POSTGRES_DB:-headysystems_dev}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    restart: always
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data

  ide:
    build:
      context: .
      dockerfile: apps/heady-automation-ide/Dockerfile
      target: deps
    restart: unless-stopped
    working_dir: /app/apps/heady-automation-ide
    command: pnpm run dev
    volumes:
      - ./.env.local:/app/.env.local
      - ./tsconfig.base.json:/app/tsconfig.base.json
      - ./apps/heady-automation-ide:/app/apps/heady-automation-ide
      - /app/apps/heady-automation-ide/node_modules
      - ./packages:/app/packages
      - /app/packages/ui/node_modules
      - /app/packages/task-manager/node_modules
      - /app/packages/core-domain/node_modules
    ports:
      - "3000:3000"
      - "4100:4100"
      - "5173:5173"
    environment:
      - CHOKIDAR_USEPOLLING=true
      - DATABASE_URL=postgresql://${POSTGRES_USER:-heady}:${POSTGRES_PASSWORD:-heady123}@db:5432/${POSTGRES_DB:-headysystems_dev}
      - REDIS_URL=redis://redis:6379
      - PORT=3000
      - NODE_ENV=production
      - HC_AUTOMATION_API_KEY=${HC_AUTOMATION_API_KEY}
      - HC_ALLOW_NONLOCAL_ORIGINS=${HC_ALLOW_NONLOCAL_ORIGINS:-false}
      - HC_AUTOMATION_ALLOWED_ORIGINS=${HC_AUTOMATION_ALLOWED_ORIGINS:-}
    depends_on:
      - db
      - redis

  tunnel:
    image: cloudflare/cloudflared:latest
    restart: unless-stopped
    profiles:
      - tunnel
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${TUNNEL_TOKEN}
    depends_on:
      - ide

volumes:
  postgres_data:
  redis_data:
